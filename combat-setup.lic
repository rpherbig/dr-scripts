=begin
    Before running this script for the first time, you MUST add a method for each of your characters which sets the following CombatVars (change the values to match your needs):
        CombatVars.weapon_training = {
            "Brawling" => "",
            "Bow" => "bow",
            "Large Edged" => "sword",
            "Twohanded Edged" => "sword",
        }

    Use the single noun for an item, "sword" not "bastard sword"

    Your new method MAY also need to override any CombatVars set in baseline_setup.
    * Be sure not to change baseline_setup itself, as this is common to all characters.
    * See below for some example methods for various guilds.
    * Be aware of the difference in overwriting something that was set in baseline_setup vs updating it.
        * This will insert a new key or replace the key if it exists in a hash: CombatVars.buff_spells["See the Wind"] = { ... }
        * This will overwrite a hash: CombatVars.buff_spells = {"See the Wind" => { ... } }
        * This will append to an array: CombatVars.offensive_spells << { ... }
        * This will overwrite an array: CombatVars.offensive_spells = [ ... ]
    * You can turn on debug mode by setting CombatVars.combat_trainer_debug = true
=end

class CombatTrainerSetup
  include DRC

  def main(args:[])
    baseline_setup

    case checkname
    when 'Etreu' # Ranger
      etreu
      etreu_backtrain if args.include? 'back'
    when 'Menacra' # Cleric
      menacra
      menacra_undead if args.include? 'undead'
      menacra_defend if args.include? 'defend'
    when 'Selanas' # Empath
      selanas
    when 'Sarikis' # Moon Mage
      sarikis
    when 'Thurmond' # Bard
      thurmond
    when 'Sheltim' # Barbarian
      sheltim
      app
      debug
    when 'Torgro' # Warrior Mage
      torgro
      debug
    else
      echo "***DON'T USE THE BASELINE PROFILE***"
      echo 'Open and edit combat-trainer-setup.lic'
    end
    debug if args.include? 'debug'
    darg = args.find { |arg| arg =~ /d\d+/ }
    set_dance(darg) if darg
    rarg = args.find { |arg| arg =~ /r\d+/ }
    set_retreat(rarg) if rarg
    app if args.include? 'app'

    start_script('combat-trainer')
    pause 0.25 while running?('combat-trainer')

    $COMBAT_TRAINER = CombatTrainer.new
    $COMBAT_TRAINER.main(CombatVars)
  end

  def baseline_setup
    # Actions to fill aiming time with
    CombatVars.aim_fillers = {
      'Crossbow' => %w(bob bob),
      'Bow' => %w(bob bob)
    }

    # If this exists it will use these actions while stealth exp is not capped
    CombatVars.aim_fillers_stealth = {
      'Bow' => %w(bob hide)
    }

    CombatVars.lootables = %w(bolt arrow coin)

    # The names of weapons which are worn, not stowed
    CombatVars.worn_weapons = %w(crossbow bow)

    # Leave a skill undefined to allow the script to balance defenses for learning
    # For skills that must use a certain defense arrangement you can specify the ordering of defenses with an array.
    # ["parry", "evasion"] = 100 parry 80 evasion
    # ["evasion", "parry"] = 100 evasion 80 parry
    CombatVars.stances = {
      'Bow' => %w(evasion shield),
      'Crossbow' => %w(evasion shield),
      'Slings' => %w(evasion shield),
      'Offhand Weapon' => %w(evasion shield)
    }

    CombatVars.offensive_spells = []
    CombatVars.buff_spells = {}
    CombatVars.buff_nonspells = {}

    CombatVars.skinning = {
      'skin' => true, # Set this to false to disable all skinning
      'arrange_all' => false, # Do you have the ability to arrange all?
      'arrange_count' => 5 # Number of times to arrange, anything over max arranges is treated as max.
    }

    # Worn chargable cambrinth
    CombatVars.cambrinth = 'armband'

    # Which charged maneuvers to use - this will be ignored for weapon skills that are not trained
    # https://elanthipedia.play.net/mediawiki/index.php/Combat_Maneuvers#Charged_Maneuvers
    CombatVars.charged_maneuvers = {
      'Brawling' => 'palmstrike',
      'Bow' => 'powershot',
      'Crossbow' => 'powershot',
      'Slings' => 'powershot',
      'Small Edged' => 'cleave',
      'Large Edged' => 'cleave',
      'Twohanded Edged' => 'cleave',
      'Small Blunt' => 'crash',
      'Large Blunt' => 'crash',
      'Twohanded Blunt' => 'crash',
      'Staves' => 'twirl',
      'Polearms' => 'impale'
    }

    # The number of enemies to always keep in the room, no offensive actions are taken until there are more creatures then this.
    CombatVars.dance_threshold = 1

    # The skill to use when dancing, preferrably something that can block or parry as needed.
    # This must be a skill that is being trained (i.e. defined in CombatVars.weapon_training)
    CombatVars.dance_skill = 'Large Edged'

    CombatVars.dance_actions = ['bob']

    # If this exists it will use these actions while stealth exp is not capped
    CombatVars.dance_actions_stealth = []

    CombatVars.training_abilities = { 'Hunt' => { check: 'Perception', cooldown: 80 } }

    # The messages you receive when casting spells without roundtimes. (buffs, etc.)
    CombatVars.cast_messages = ['^You gesture', 'You reach with both', 'You listen intently to the air', 'You close your eyes', 'You close yours eyes', 'Your target pattern dissipates', 'You make a holy gesture', 'You raise your left hand skyward', 'Flickering shadows tear away', 'You sense a Malediction']

    CombatVars.prep_messages = ['You begin chanting a psalm', 'With meditative movements you', 'You raise your head skyward', 'With tense movements', 'You trace a careful sigil in the air', 'You trace an angular sigil in the air']

    # The fatigue threshold at which the script will stop attacking and regain fatigue
    CombatVars.fatigue_regen_threshold = 90

    # See https://elanthipedia.play.net/mediawiki/index.php/Combat_maneuvers for actions that are good candidates
    # For example, "bob" trains Tactics, but does no damage, whereas "feint" does damage, but without training an additional skill
    CombatVars.fatigue_regen_action = 'bob'
  end

  def app
    CombatVars.training_abilities['App'] = { check: 'Appraisal', cooldown: 60 }
  end

  def etreu
    CombatVars.weapon_training = {
      'Bow' => 'longbow',
      'Small Edged' => 'scimitar'
    }

    CombatVars.worn_weapons = ['longbow']

    CombatVars.aim_fillers['Bow'] = %w(bob analyze bob)
    CombatVars.aim_fillers_stealth = {
      'Bow' => %w(bob hide bob)
    }

    CombatVars.fatigue_regen_action = 'analyze'

    CombatVars.skinning['arrange_all'] = true
    CombatVars.skinning['arrange_count'] = 1

    CombatVars.dual_load = true
    CombatVars.charged_maneuvers.delete('Bow')

    CombatVars.training_abilities['Perc'] = { check: 'Attunement', cooldown: 60 * 2 }

    CombatVars.dance_actions_stealth = %w(hide stalk analyze feint bob)

    CombatVars.buff_spells = {
      'See the Wind' => { 'abbrev' => 'STW', 'recast' => 1, 'mana' => 10, 'cambrinth' => [7, 7, 6] },
      'Instinct' => { 'abbrev' => 'inst', 'recast' => 1, 'mana' => 10, 'cambrinth' => [7, 7, 6] },
      'Hands of Lirisa' => { 'abbrev' => 'hol', 'recast' => 1, 'mana' => 10, 'cambrinth' => [7, 7, 6] },
      'Sense of the Tiger' => { 'abbrev' => 'sott', 'recast' => 1, 'mana' => 10, 'cambrinth' => [7, 7, 6] },
      'Skein of Shadows' => { 'abbrev' => 'sks', 'recast' => 1, 'mana' => 15, 'cambrinth' => [5, 5, 5] },
      'Earth Meld' => { 'abbrev' => 'em', 'recast' => 1, 'mana' => 20, 'cambrinth' => [8, 7] },
      'Claws of the Cougar' => { 'abbrev' => 'cotc', 'recast' => -1, 'mana' => 15, 'cambrinth' => [8, 8] }
    }

    CombatVars.offensive_spells = [
      # { 'skill' => 'Targeted Magic', 'name' => "Eagle's Cry", 'abbrev' => 'ec', 'mana' => 10 },
      { 'skill' => 'Debilitation', 'name' => 'Devolve', 'abbrev' => 'de', 'mana' => 14, 'expire' => 'which evaporate quickly into the air' }
    ]

    CombatVars.dance_actions = %w(analyze feint bob)

    CombatVars.dance_skill = 'Small Edged'

    CombatVars.fatigue_regen_threshold = 85

    CombatVars.lootables = %w(bolt coin arrow) + UserVars.gem_nouns

    CombatVars.worn_items = [
      Item.new(name: 'balaclava', leather: false, hinders_locks: true, description: 'a lumium chain balaclava crafted from tempered links'),
      Item.new(name: 'gloves', leather: false, hinders_locks: true, description: 'some lumium mail gloves'),
      Item.new(name: 'shield', leather: true, hinders_locks: true, description: 'a shalswar-hide targe sealed with protective wax'),
      Item.new(name: 'leathers', leather: true, description: 'some thick shalswar-hide leathers with fitted seams'),
      Item.new(name: 'parry stick', leather: false, description: 'a polished steel parry stick'),
      Item.new(name: 'knuckles', leather: false, hinders_locks: true, description: 'some brass knuckles'),
      Item.new(name: 'spikes', leather: false, description: 'some silver-chased elbow spikes'),
      Item.new(name: 'longbow', leather: false, description: 'an osage battle longbow')
    ]
  end

  def etreu_backtrain
    CombatVars.weapon_training = {
      'Brawling' => '',
      'Large Edged' => 'sword',
      'Small Blunt' => 'bola',
      'Light Thrown' => 'bola',
      'Twohanded Edged' => 'sword',
      'Offhand Weapon' => 'bola'
    }

    CombatVars.dance_skill = 'Large Edged'

    CombatVars.skinning['skin'] = false

    CombatVars.buff_spells = {}
    CombatVars.offensive_spells = {}
    CombatVars.buff_spells['Instinct'] = { 'abbrev' => 'inst', 'recast' => 1, 'mana' => 6, 'cambrinth' => [14] }
    CombatVars.buff_spells['Claws of the Cougar'] = { 'abbrev' => 'cotc', 'recast' => -1, 'mana' => 15, 'cambrinth' => [6] }

    CombatVars.dance_threshold = 0
  end

  def thurmond
    CombatVars.weapon_training = {
      'Bow' => 'longbow',
      'Offhand Weapon' => 'bola',
      'Small Blunt' => 'bola',
      'Light Thrown' => 'bola',
      'Large Edged' => 'sword',
      'Large Blunt' => 'sledgehammer',
      'Twohanded Edged' => 'sword',
      'Brawling' => ''
    }

    CombatVars.worn_weapons = ['longbow']

    CombatVars.aim_fillers['Bow'] = %w(bob analyze bob)

    CombatVars.fatigue_regen_action = 'bob'

    CombatVars.skinning['arrange_all'] = false
    CombatVars.skinning['arrange_count'] = 0

    CombatVars.charged_maneuvers.delete('Bow')

    CombatVars.training_abilities['Perc'] = { check: 'Attunement', cooldown: 60 * 2 }
    CombatVars.training_abilities['Scream'] = { check: 'Bardic Lore', cooldown: 15 }

    CombatVars.offensive_spells = [
      { 'skill' => 'Targeted Magic', 'name' => 'Breath of Storms', 'abbrev' => 'bos', 'mana' => 6 },
      { 'skill' => 'Debilitation', 'name' => 'DMRS', 'abbrev' => 'dmrs', 'mana' => 6 }
    ]

    CombatVars.dance_actions = %w(analyze feint bob)

    CombatVars.dance_skill = 'Large Edged'

    CombatVars.fatigue_regen_threshold = 85

    CombatVars.lootables = %w(bolt coin arrow) + UserVars.gem_nouns
    end

  def menacra
    CombatVars.weapon_training = {
      'Brawling' => '',
      'Crossbow' => 'crossbow',
      'Large Edged' => 'sword',
      'Large Blunt' => 'hammer',
      'Heavy Thrown' => 'hammer'
    }

    CombatVars.skinning['arrange_count'] = 1

    CombatVars.training_abilities['Perc'] = { check: 'Attunement', cooldown: 60 * 2 }
    CombatVars.training_abilities['Pray'] = { check: 'Theurgy', cooldown: 610 }

    CombatVars.buff_spells['Shield of Light'] = { 'abbrev' => 'sol', 'recast' => 1, 'mana' => 15, 'cambrinth' => [5, 5], 'after' => proc { bput('wear shield', 'your shield dissolves', 'you are already wearing') } }
    CombatVars.buff_spells['Benediction'] = { 'abbrev' => 'benediction', 'recast' => 1, 'mana' => 10, 'cambrinth' => [5, 5] }
    CombatVars.buff_spells['Major Physical Protection'] = { 'abbrev' => 'MAPP', 'recast' => 1, 'mana' => 15, 'cambrinth' => [5] }
    CombatVars.buff_spells['Minor Physical Protection'] = { 'abbrev' => 'MPP', 'recast' => 1, 'mana' => 15, 'cambrinth' => [5] }
    CombatVars.buff_spells['Centering'] = { 'abbrev' => 'Centering', 'recast' => 1, 'mana' => 15, 'cambrinth' => [8, 7] }

    CombatVars.cambrinth = 'armband'

    CombatVars.dance_actions = %w(bob bob bob bob)

    CombatVars.offensive_spells = [
      { 'skill' => 'Targeted Magic', 'name' => 'Fists of Faenella', 'abbrev' => 'ff', 'mana' => 12 },
      { 'skill' => 'Debilitation', 'name' => 'Malediction', 'abbrev' => 'maled', 'mana' => 12, 'expire' => 'The swirling confines of malevolent darkness' }
    ]

    CombatVars.dance_threshold = 0
    CombatVars.lootables = %w(bolt coin arrow) + UserVars.gem_nouns
  end

  def sarikis
    CombatVars.weapon_training = {
      'Brawling' => '',
      'Small Blunt' => 'bola',
      'Small Edged' => 'dagger',
      'Offhand Weapon' => 'dagger',
      'Light Thrown' => 'bola',
      'Crossbow' => 'crossbow'
    }

    CombatVars.skinning['arrange_count'] = 0

    CombatVars.dance_actions = %w(bob bob bob bob)

    CombatVars.dance_actions_stealth = %w(bob hide stalk bob)

    CombatVars.aim_fillers_stealth = {
      'Crossbow' => %w(bob hide)
    }

    CombatVars.dance_skill = 'Small Edged'

    CombatVars.charged_maneuvers.delete('Crossbow')

    # CombatVars.training_abilities['PercMana'] = { check: 'Attunement', cooldown: 60 * 2 }
    CombatVars.training_abilities['Astro'] = { chec: 'Astrology', cooldown: 60 * 6 }

    CombatVars.offensive_spells = [
      { 'skill' => 'Targeted Magic', 'name' => 'Dinazen Olkar', 'abbrev' => 'DO', 'mana' => 10 },
      { 'skill' => 'Debilitation', 'name' => 'Sleep', 'abbrev' => 'Sleep', 'mana' => 7 }
    ]

    CombatVars.buff_spells['Shadows'] = { 'abbrev' => 'shadows', 'recast' => 1, 'mana' => 5 }
    CombatVars.buff_spells['Seer\'s Sense'] = { 'abbrev' => 'seer', 'recast' => 1, 'mana' => 14 }
    CombatVars.buff_spells['Psychic Shield'] = { 'abbrev' => 'psy', 'recast' => 1, 'mana' => 5 }

    CombatVars.dance_threshold = 2

    CombatVars.lootables = %w(bolt coin) + UserVars.box_nouns
  end

  def set_dance(message)
    message =~ /d(\d+)/
    CombatVars.dance_threshold = Regexp.last_match(1).to_i
  end

  def set_retreat(message)
    message =~ /r(\d+)/
    CombatVars.retreat_threshold = Regexp.last_match(1).to_i
  end

  def menacra_undead
    CombatVars.buff_spells['Bless'] = { 'abbrev' => 'bless', 'recast' => 1, 'mana' => 25, 'cambrinth' => [5] }
    CombatVars.buff_spells['Protection from Evil'] = { 'abbrev' => 'pfe', 'recast' => 1, 'mana' => 15, 'cambrinth' => [5] }
  end

  def menacra_defend
    CombatVars.offensive_spells = []
    CombatVars.dance_skill = 'Large Edged'
    CombatVars.dance_threshold = 3
  end

  def selanas
    CombatVars.lootables = %w(coin)

    CombatVars.weapon_training = {
      'Brawling' => ''
    }

    CombatVars.stances = {
      'Brawling' => %w(evasion shield)
    }

    CombatVars.buff_spells['Iron Constitution'] = { 'abbrev' => 'IC', 'recast' => 1, 'mana' => 15, 'cambrinth' => [4] }
    CombatVars.buff_spells['Refresh'] = { 'abbrev' => 'refresh', 'recast' => 1, 'mana' => 15, 'cambrinth' => [4]  }

    CombatVars.offensive_spells = [
      { 'skill' => 'Debilitation', 'name' => 'Lethargy', 'abbrev' => 'Lethargy', 'mana' => 9 },
      { 'skill' => 'Targeted Magic', 'name' => 'Paralysis', 'abbrev' => 'Paralysis', 'mana' => 7 }
    ]

    CombatVars.skinning = {
      'skin' => true, # Set this to false to disable all skinning
      'arrange_all' => false, # Do you have the ability to arrange all?
      'arrange_count' => 0 # Number of times to arrange, anything over max arranges is treated as max.
    }

    CombatVars.empath = { manipulate: true }

    CombatVars.cambrinth = 'ear'

    CombatVars.charged_maneuvers = {}

    CombatVars.dance_threshold = 100

    CombatVars.dance_skill = 'Brawling'

    CombatVars.dance_actions = %w(bob circle bob bob)

    CombatVars.dance_actions_stealth = %w(bob hide stalk bob)
  end

  def sheltim
    CombatVars.weapon_training = {
      'Brawling' => '',
      'Bow' => 'bow',
      'Large Edged' => 'sword',
      'Large Blunt' => 'hammer',
      'Heavy Thrown' => 'hammer',
      'Twohanded Blunt' => 'flail',
      'Twohanded Edged' => 'sword',
      'Offhand Weapon' => 'hammer'
    }

    CombatVars.dance_actions_stealth = %w(hide stalk bob bob)

    CombatVars.worn_weapons = []

    # CombatVars.buff_nonspells['form python'] = 60 * 5
    # CombatVars.buff_nonspells['berserk earthquake'] = 60 * 1
    CombatVars.buff_nonspells['form badger'] = 60 * 5

    CombatVars.lootables += UserVars.box_nouns + UserVars.gem_nouns
  end

  def torgro
    CombatVars.weapon_training = {
      'Brawling' => '',
      'Twohanded Edged' => 'sword',
      'Large Edged' => 'sword',
      'Large Blunt' => 'hammer',
      'Heavy Thrown' => 'hammer',
      'Polearms' => 'bardiche',
      'Bow' => 'bow'
    }

    CombatVars.worn_weapons = ['bardiche']

    CombatVars.skinning['arrange_count'] = 0

    CombatVars.cambrinth = 'ring'

    CombatVars.offensive_spells = [
      { 'skill' => 'Targeted Magic', 'name' => 'Fire Shards', 'abbrev' => 'fs', 'mana' => 10 },
      { 'skill' => 'Debilitation', 'name' => 'Mark of Arhat', 'abbrev' => 'moa', 'mana' => 10 }
    ]

    CombatVars.buff_spells = {
      'Ethereal Shield' => { 'abbrev' => 'ES', 'recast' => 1, 'mana' => 10 },
      'Substratum' => { 'abbrev' => 'SUB', 'recast' => 1, 'mana' => 10 },
      'Sure Footing' => { 'abbrev' => 'SUF', 'recast' => 1, 'mana' => 10 },
      'Tailwind' => { 'abbrev' => 'TW', 'recast' => 1, 'mana' => 10 },
      'Manifest Force' => { 'abbrev' => 'MAF', 'recast' => 1, 'mana' => 11 },
      'Swirling Winds' => { 'abbrev' => 'SW', 'recast' => 1, 'mana' => 10 }
    }

    CombatVars.buff_nonspells['pathway focus damage'] = 60 * 5

    CombatVars.training_abilities['Perc'] = { check: 'Attunement', cooldown: 60 * 2 }

    CombatVars.charged_maneuvers = {}

    CombatVars.lootables += UserVars.gem_nouns
  end

  def debug
    CombatVars.combat_trainer_debug = true
  end

  module CombatVars
    @@vars = {}
    def self.[](name)
      @@vars[name]
    end

    def self.reset
      @@vars = {}
    end

    def self.[]=(name, val)
      if val.nil?
        @@vars.delete(name)
      else
        @@vars[name] = val
      end
    end

    def self.list
      @@vars.dup
    end

    def self.method_missing(arg1, arg2 = '')
      if arg1[-1, 1] == '='
        if arg2.nil?
          @@vars.delete(arg1.to_s.chop)
        else
          @@vars[arg1.to_s.chop] = arg2
        end
      else
        @@vars[arg1.to_s]
      end
    end
  end
end

CombatTrainerSetup.new.main(args: variable.drop(1))
